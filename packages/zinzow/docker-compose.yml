name: ${STACK_NAME}

services:
  db:
    environment:
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_USER=${DB_USERNAME}
    healthcheck:
      test: pg_isready -U $DB_USERNAME
    image: postgres:15-alpine
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql/data

  cms:
    environment:
      - SECRET=${CMS_SECRET}
      - ADMIN_EMAIL=${CMS_USERNAME}
      - ADMIN_PASSWORD=${CMS_PASSWORD}
      - PUBLIC_URL=https://cms.${DOMAIN}
      - DB_CLIENT=pg
      - DB_HOST=db
      - DB_PORT=5432
      - DB_DATABASE=directus
      - DB_USER=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
    image: directus/directus:11
    restart: unless-stopped
    volumes:
      - directus-uploads:/directus/uploads
      - directus-extensions:/directus/extensions

  tunnel:
    command:
      - tunnel
      - --no-autoupdate
      - run
      - --token
      - ${TUNNEL_TOKEN}
    image: cloudflare/cloudflared
    restart: unless-stopped

  website:
    cap_drop:
      - ALL
    environment:
      - PORT=4300
    image: ${IMAGE_BASE}/zinzow-website
    read_only: true
    restart: unless-stopped

volumes:
  postgres-data:
  directus-uploads:
  directus-extensions:
